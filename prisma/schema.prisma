// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum TipoUsuario{
  publico
  privado
}

enum EstadoSolicitud{
  pendiente
  aceptado
  rechazado
}

model Usuario {
 id String @id @default(uuid()) @map("id_usuario") 
  correo       String   @unique @db.VarChar(254)
  username     String   @unique @db.VarChar(30)
  nombre       String   @db.VarChar(80)
  hash String   @db.VarChar(255)
  salt String   @db.VarChar(255)
  createdAt DateTime @default(now()) @map("created_at")  
  descripcion  String?  @db.VarChar(280)
  deletedAt DateTime? @map("deleted_at")
  tipo TipoUsuario @default(publico)
  publicaciones Publicacion[]
  comentarios Comentario[]
  likesPublicaciones   LikesPublicacion[]
  likesComentarios   LikesComentario[]
  mensajes  Mensaje[]

  amigosComoUsuario1   Amigos[] @relation("AmigosDe")
  amigosComoUsuario2   Amigos[] @relation("AmigosA")
  solicitudesEnviadas  Amigos[] @relation("SolicitudesEnviadas")
  
  chatsComoUsuario1    Chat[] @relation("ChatUsuario1")
  chatsComoUsuario2    Chat[] @relation("ChatUsuario2")

   @@map("usuarios")
}


model Publicacion {
  id        String   @id @default(uuid()) @map("id_publicacion")
  usuarioId String   @map("id_usuario")  
  contenido String   @db.Text
  createdAt DateTime @default(now()) @map("created_at")
  
  usuario     Usuario @relation(fields: [usuarioId], references: [id], onDelete: Restrict)
  comentarios Comentario[]
  likes       LikesPublicacion[]
  
  @@index([usuarioId])  
  @@map("publicaciones")
}

model Comentario{
  id String @id @default(uuid()) @map("id_comentario")
  contenido String   @db.Text
  usuarioId String   @map("id_usuario")
  createdAt DateTime @default(now()) @map("created_at")
  publicacionId String @map("id_publicacion")
  comentarioPadreId String? @map("id_comentario_padre")
  likes       LikesComentario[]

  publicacion Publicacion @relation(fields: [publicacionId], references: [id], onDelete: Cascade)

  usuario Usuario @relation(fields: [usuarioId], references: [id], onDelete: Restrict)

// Auto-relaci√≥n: comentario padre e hijos
  padre      Comentario?  @relation("RespuestasComentario", fields: [comentarioPadreId], references: [id], onDelete: Cascade)
  respuestas Comentario[] @relation("RespuestasComentario")


  @@index([publicacionId])
  @@index([usuarioId])
  @@index([comentarioPadreId])
  @@map("comentarios")
}

model LikesPublicacion{
  usuarioId String @map("id_usuario")
  publicacionId String @map("id_publicacion")
  createdAt DateTime @default(now()) @map("created_at")

  publicacion Publicacion @relation(fields: [publicacionId], references: [id], onDelete: Cascade)

  usuario Usuario @relation(fields: [usuarioId], references: [id], onDelete: Cascade)

  @@id([usuarioId, publicacionId])
  @@index([publicacionId])  
  @@map("likes_publicacion")

}

model LikesComentario{
  usuarioId String @map("id_usuario")
  comentarioId String @map("id_comentario")
  createdAt DateTime @default(now()) @map("created_at")

  comentario Comentario @relation(fields: [comentarioId], references: [id], onDelete: Cascade)

  usuario Usuario @relation(fields: [usuarioId], references: [id], onDelete: Cascade)

  @@id([usuarioId, comentarioId])
  @@index([comentarioId])  
  @@map("likes_comentario")

}

model Amigos{
usuarioId1 String @map("id_usuario_1")
usuarioId2 String @map("id_usuario_2")
solicitadoPor String @map("solicitado_por")
estado EstadoSolicitud @default(pendiente)
createdAt DateTime @default(now()) @map("created_at")
respondidoAt DateTime? @map("respondido_at")

  usuario1   Usuario @relation("AmigosDe", fields: [usuarioId1], references: [id], onDelete: Cascade)
  usuario2   Usuario @relation("AmigosA", fields: [usuarioId2], references: [id], onDelete: Cascade)
  solicitante Usuario @relation("SolicitudesEnviadas", fields: [solicitadoPor], references: [id], onDelete: Cascade)
  
  @@id([usuarioId1, usuarioId2])
  @@index([usuarioId1])
  @@index([usuarioId2])
  @@index([estado])
  @@map("amigos")
}


model Chat {
  id             String   @id @default(uuid()) @map("id_chat")
  usuarioId1     String   @map("id_usuario_1")
  usuarioId2     String   @map("id_usuario_2")
  createdAt      DateTime @default(now()) @map("created_at")
  
  usuario1 Usuario @relation("ChatUsuario1", fields: [usuarioId1], references: [id], onDelete: Cascade)
  usuario2 Usuario @relation("ChatUsuario2", fields: [usuarioId2], references: [id], onDelete: Cascade)
  mensajes Mensaje[]
  
  @@unique([usuarioId1, usuarioId2])
  @@index([usuarioId1])
  @@index([usuarioId2])
  @@map("chats")
}

model Mensaje{
  id             String   @id @default(uuid()) @map("id_mensaje")
  chatId String @map("id_chat")
  usuarioId String @map("id_usuario")
  contenido String   @db.Text
  createdAt      DateTime @default(now()) @map("created_at")

  chat Chat @relation(fields: [chatId], references: [id], onDelete: Cascade)
  usuario Usuario @relation(fields: [usuarioId], references: [id], onDelete: Cascade)

  @@index([chatId])
  @@index([usuarioId])
  @@index([createdAt])
  @@map("mensajes")
}
